pipeline {
    agent any

    parameters {
        choice(name: 'EXECUTION_MODE', choices: ['LOCAL', 'GRID'], description: 'Mode dâ€™exÃ©cution')
        choice(name: 'BROWSER', choices: ['chrome', 'firefox', 'edge'], description: 'Navigateur cible')
    }

    stages {
        stage('Checkout') {
            steps {
                echo "ðŸ“¥ RÃ©cupÃ©ration du code source..."
                checkout scm
            }
        }

        stage('Start Selenium Grid') {
            when {
                expression { params.EXECUTION_MODE == 'GRID' }
            }
            steps {
                echo "ðŸš€ DÃ©marrage du Grid avec docker compose..."
                sh 'docker compose -f docker-compose.yaml up -d'

                echo "â³ Attente que le hub soit prÃªt..."
                script {
                    int retries = 6
                    boolean ready = false
                    while(retries > 0 && !ready) {
                        try {
                            sh 'curl -s http://localhost:4444/status | grep -q "ready"'
                            ready = true
                        } catch (Exception e) {
                            echo "Hub pas encore prÃªt, attente 5s..."
                            sleep 5
                            retries--
                        }
                    }
                    if (!ready) error "Le Selenium Grid nâ€™est pas prÃªt aprÃ¨s 30s"
                }
            }
        }

        stage('Run Tests') {
            steps {
                echo "ðŸ§ª Lancement des tests (${params.BROWSER})..."
                sh "mvn clean test -Dbrowser=${params.BROWSER}"
            }
            post {
                always {
                    echo "ðŸ“Š Publication des rapports..."
                    junit '**/target/surefire-reports/*.xml'
                    cucumber buildStatus: 'UNSTABLE', fileIncludePattern: '**/target/cucumber-reports/*.json'
                }
            }
        }

        stage('Stop Selenium Grid') {
            when {
                expression { params.EXECUTION_MODE == 'GRID' }
            }
            steps {
                echo "ðŸ›‘ ArrÃªt du Grid..."
                sh 'docker compose -f docker-compose.yaml down'
            }
        }
    }

    post {
        always {
            echo "âœ… Pipeline terminÃ©."
        }
    }
}
