pipeline {
    agent any

    parameters {
        booleanParam(name: 'HEADLESS', defaultValue: true, description: 'Exécuter les tests en mode headless ?')
    }

    stages {
        stage('Checkout') {
            steps {
                echo "📥 Récupération du code source..."
                checkout scm
            }
        }

        stage('Run_Test') {
            steps {
                echo "🏃 Exécution des tests Maven..."
                script {
                    // Exécution Maven en capturant le statut sans afficher les erreurs brutes
                    def status = sh(script: "mvn clean test -Dchrome.headless=${params.HEADLESS} -q", returnStatus: true)
                    if (status != 0) {
                        echo "⚠️ Certains tests ont échoué, le build sera marqué comme UNSTABLE."
                        currentBuild.result = 'UNSTABLE'
                    }
                }
            }
        }
    }

    post {
        always {
            echo "📊 Publication des rapports..."
            // JUnit
            junit '**/target/surefire-reports/*.xml'
            // Cucumber
            cucumber buildStatus: 'UNSTABLE', fileIncludePattern: '**/target/cucumber-reports/*.json'
        }
    }
}
