pipeline {
    agent any

    parameters {
        booleanParam(name: 'HEADLESS', defaultValue: true, description: 'ExÃ©cuter les tests en mode headless ?')
    }

    stages {
        stage('Checkout') {
            steps {
                echo "ğŸ“¥ RÃ©cupÃ©ration du code source..."
                checkout scm
            }
        }

        stage('Run_Test') {
            steps {
                echo "ğŸƒ ExÃ©cution des tests Maven..."
                script {
                    // ExÃ©cution Maven en capturant le statut sans afficher les erreurs brutes
                    def status = sh(script: "mvn clean test -Dchrome.headless=${params.HEADLESS} -q", returnStatus: true)
                    if (status != 0) {
                        echo "âš ï¸ Certains tests ont Ã©chouÃ©, le build sera marquÃ© comme UNSTABLE."
                        currentBuild.result = 'UNSTABLE'
                    }
                }
            }
        }
    }

    post {
        always {
            echo "ğŸ“Š Publication des rapports..."
            // JUnit
            junit '**/target/surefire-reports/*.xml'
            // Cucumber
            cucumber buildStatus: 'UNSTABLE', fileIncludePattern: '**/target/cucumber-reports/*.json'
        }
    }
}
